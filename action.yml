name: 'Submit Job'
description: 'Submits/triggers Kubernetes CronJobs or Argo Workflows'
author: 'KoalaOps'

branding:
  icon: 'play'
  color: 'purple'

inputs:
  job_type:
    description: 'Type of job (kubernetes-cronjob, argo-workflow, argo-cronworkflow)'
    required: true
  resource_name:
    description: 'Name of the resource to trigger (CronJob/WorkflowTemplate/CronWorkflow)'
    required: true
  namespace:
    description: 'Kubernetes namespace'
    required: true
  parameters:
    description: 'JSON object of parameters for Argo workflows (e.g., {"key1":"value1","key2":"value2"})'
    required: false
    default: ''
  argo_version:
    description: 'Argo CLI version to install (only for Argo workflows)'
    required: false
    default: '3.5.3'

outputs:
  created_name:
    description: 'Name of the created Job or Workflow'
    value: ${{ steps.execute-cronjob.outputs.job_name || steps.execute-argo.outputs.workflow_name }}
  created_kind:
    description: 'Kind of the created resource (job or workflow)'
    value: ${{ steps.execute-cronjob.outputs.kind || steps.execute-argo.outputs.kind }}

runs:
  using: 'composite'
  steps:
    - name: Validate job type
      shell: bash
      run: |
        JOB_TYPE="${{ inputs.job_type }}"
        case "$JOB_TYPE" in
          kubernetes-cronjob|argo-workflow|argo-cronworkflow)
            echo "âœ… Valid job type: $JOB_TYPE"
            ;;
          *)
            echo "::error::Invalid job_type: $JOB_TYPE. Must be one of: kubernetes-cronjob, argo-workflow, argo-cronworkflow"
            exit 1
            ;;
        esac

    - name: Install Argo CLI
      if: startsWith(inputs.job_type, 'argo-')
      shell: bash
      run: |
        set -euo pipefail
        ARGO_VERSION="${{ inputs.argo_version }}"

        echo "ðŸ“¦ Installing Argo CLI v${ARGO_VERSION}..."
        curl -sLO "https://github.com/argoproj/argo-workflows/releases/download/v${ARGO_VERSION}/argo-linux-amd64.gz"
        gunzip argo-linux-amd64.gz
        chmod +x argo-linux-amd64
        sudo mv argo-linux-amd64 /usr/local/bin/argo

        echo "âœ… Argo CLI installed:"
        argo version

    - name: Execute Kubernetes CronJob
      if: inputs.job_type == 'kubernetes-cronjob'
      id: execute-cronjob
      shell: bash
      run: |
        set -euo pipefail
        NAME="${{ inputs.resource_name }}"
        NS="${{ inputs.namespace }}"

        echo "ðŸš€ Creating Job from CronJob '${NAME}' in namespace '${NS}'"

        # Generate unique job name with timestamp
        BASE="${NAME}-manual"
        TS="$(date +%s)"
        JNAME="${BASE}-${TS}"

        # Ensure name doesn't exceed 63 characters (K8s limit)
        if [ ${#JNAME} -gt 63 ]; then
          CUT=$((63 - 11))  # reserve "-1234567890" for timestamp
          JNAME="$(echo "$BASE" | cut -c1-$CUT)-${TS}"
        fi

        # Create job from cronjob
        kubectl create job "$JNAME" --from=cronjob/"$NAME" -n "$NS"

        echo "âœ… Created Job: $JNAME"
        kubectl describe job/"$JNAME" -n "$NS"

        # Set outputs
        echo "job_name=$JNAME" >> "$GITHUB_OUTPUT"
        echo "kind=job" >> "$GITHUB_OUTPUT"

    - name: Execute Argo Workflow
      if: startsWith(inputs.job_type, 'argo-')
      id: execute-argo
      shell: bash
      run: |
        set -euo pipefail
        NS="${{ inputs.namespace }}"
        NAME="${{ inputs.resource_name }}"
        JOB_TYPE="${{ inputs.job_type }}"
        PARAMS="${{ inputs.parameters }}"

        # If parameters provided, print a safe, partially masked preview
        if [ -n "$PARAMS" ] && [ "$PARAMS" != "null" ]; then
          echo "ðŸ”§ Parameters (partially masked):"
          # Iterate keys and render safe preview
          while IFS= read -r key; do
            type=$(jq -r --arg k "$key" '(.[$k] | type)' <<<"$PARAMS")

            case "$type" in
              string)
                val=$(jq -r --arg k "$key" '.[$k]' <<<"$PARAMS")
                # Always mask full raw value so it won't leak elsewhere in logs
                printf '::add-mask::%s\n' "$val"

                len=${#val}
                if [ "$len" -le 6 ]; then
                  masked="$(printf '%*s' "$len" '' | tr ' ' '*')"   # fully mask short strings
                else
                  masked="${val:0:3}***${val: -2}"
                fi
                echo "  - $key: \"$masked\" (len=$len)"
                ;;

              number|boolean)
                val=$(jq -r --arg k "$key" '.[$k]' <<<"$PARAMS")
                echo "  - $key: $val"
                ;;

              array)
                n=$(jq -r --arg k "$key" '(.[$k] | length)' <<<"$PARAMS")
                echo "  - $key: array(len=$n)"
                ;;

              object)
                n=$(jq -r --arg k "$key" '(.[$k] | keys | length)' <<<"$PARAMS")
                echo "  - $key: object(keys=$n)"
                ;;

              null)
                echo "  - $key: null"
                ;;

              *)
                echo "  - $key: <$type>"
                ;;
            esac
          done < <(jq -r 'keys[]' <<<"$PARAMS")
        fi

        # Build parameter flags safely (array preserves spaces/equals)
        declare -a PARAM_FLAGS=()
        if [ -n "$PARAMS" ] && [ "$PARAMS" != "null" ]; then
          while IFS= read -r kv; do
            PARAM_FLAGS+=(-p "$kv")
          done < <(jq -r 'to_entries[] | "\(.key)=\(.value|tostring)"' <<<"$PARAMS")
        fi

        # Submit workflow based on type
        if [ "$JOB_TYPE" = "argo-cronworkflow" ]; then
          echo "ðŸš€ Submitting from CronWorkflow/${NAME} in namespace ${NS}"
          CREATED_JSON=$(argo submit --from "cronwf/${NAME}" -n "${NS}" ${PARAM_FLAGS} -o json)
        else
          echo "ðŸš€ Submitting from WorkflowTemplate/${NAME} in namespace ${NS}"
          CREATED_JSON=$(argo submit --from "workflowtemplate/${NAME}" -n "${NS}" ${PARAM_FLAGS} -o json)
        fi

        # Extract workflow name
        WF_NAME="$(echo "$CREATED_JSON" | jq -r '.metadata.name')"

        echo "âœ… Created workflow: ${WF_NAME}"
        kubectl describe workflow/"${WF_NAME}" -n "${NS}"

        # Set outputs
        echo "workflow_name=$WF_NAME" >> "$GITHUB_OUTPUT"
        echo "kind=workflow" >> "$GITHUB_OUTPUT"
